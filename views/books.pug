html
  head
    meta(charset="utf-8")
    title= title
    link(rel="stylesheet", href="/public/css/style.css")
    link(rel="stylesheet", href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css")
    style.
      .loading {
        text-align: center;
        padding: 2rem;
        color: #666;
      }
      .loading i {
        font-size: 2rem;
        margin-bottom: 1rem;
      }
      .no-books {
        text-align: center;
        padding: 3rem;
        color: #666;
        grid-column: 1 / -1;
      }
      .no-books i {
        font-size: 3rem;
        color: #ccc;
        margin-bottom: 1rem;
      }
  body.books-page 
    header
      h1
        i.fas.fa-book
        |  #{title}
      nav
        a(href="/")
          i.fas.fa-home
          |  –ì–ª–∞–≤–Ω–∞—è
        a(href="/books")
          i.fas.fa-list
          |  –í—Å–µ –∫–Ω–∏–≥–∏
        a(href="/books/add/new")
          i.fas.fa-plus-circle
          |  –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
    
    main
      //- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
      .library-stats
        h2
          i.fas.fa-chart-bar
          |  –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
        .stats-grid
          .stat-item
            i.fas.fa-book.total
            .stat-info
              .stat-number#totalBooks #{statistics.totalBooks}
              .stat-label –í—Å–µ–≥–æ –∫–Ω–∏–≥
          .stat-item
            i.fas.fa-check-circle.available
            .stat-info
              .stat-number#availableBooks #{statistics.availableBooks}
              .stat-label –î–æ—Å—Ç—É–ø–Ω–æ
          .stat-item
            i.fas.fa-user-check.borrowed
            .stat-info
              .stat-number#borrowedBooks #{statistics.borrowedBooks}
              .stat-label –í—ã–¥–∞–Ω–æ
          .stat-item
            i.fas.fa-clock.expiring
            .stat-info
              .stat-number#expiringBooks #{statistics.expiringBooks}
              .stat-label –°–∫–æ—Ä–æ —Å—Ä–æ–∫

      //- –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
      .filters-section
        h3
          i.fas.fa-filter
          |  –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        
        .filter-controls
          .filter-group
            label
              i.fas.fa-filter
              |  –§–∏–ª—å—Ç—Ä:
            select#filterSelect
              option(value="all" selected=filter === 'all') –í—Å–µ –∫–Ω–∏–≥–∏
              option(value="available" selected=filter === 'available') –î–æ—Å—Ç—É–ø–Ω—ã–µ
              option(value="borrowed" selected=filter === 'borrowed') –í—ã–¥–∞–Ω–Ω—ã–µ
              option(value="expiring" selected=filter === 'expiring') –°–∫–æ—Ä–æ —Å—Ä–æ–∫
            
          .sort-group
            label
              i.fas.fa-sort
              |  –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:
            select#sortSelect
              option(value="title" selected=sort === 'title') –ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é
              option(value="author" selected=sort === 'author') –ü–æ –∞–≤—Ç–æ—Ä—É
              option(value="year" selected=sort === 'year') –ü–æ –≥–æ–¥—É
              option(value="dueDate" selected=sort === 'dueDate') –ü–æ –¥–∞—Ç–µ –≤–æ–∑–≤—Ä–∞—Ç–∞

      //- –°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
      .books-section
        h3#booksTitle
          i.fas.fa-books
          |  #{message}
        
        .books-container#booksContainer
          each book in books
            - const safeTitle = book.title.replace(/'/g, "\\'")
            - const safeAuthor = book.author.replace(/'/g, "\\'")
            - const safeGenre = book.genre.replace(/'/g, "\\'")
            .book-card(id=`book-${book.id}`)
              .book-header
                h4
                  i.fas.fa-book
                  |  #{book.title}
                .book-actions
                  if book.isAvailable
                    span.status.available
                      i.fas.fa-check-circle
                      |  –î–æ—Å—Ç—É–ø–Ω–∞
                  else
                    span.status.borrowed
                      i.fas.fa-user-clock
                      |  –í—ã–¥–∞–Ω–∞: #{book.borrower}
                  
                  .action-buttons
                    button.btn.btn-info(onclick=`showBookDetails(${JSON.stringify(book).replace(/'/g, "\\'")})` title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ")
                      i.fas.fa-info
                    button.btn.btn-warning(onclick=`showEditDialog('${book.id}', '${safeTitle}', '${safeAuthor}', '${book.year}', '${safeGenre}')` title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É")
                      i.fas.fa-edit
                    if book.isAvailable
                      button.btn.btn-success(onclick=`showBorrowDialog('${book.id}', '${safeTitle}')` title="–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É")
                        i.fas.fa-hand-holding
                    else
                      button.btn.btn-info(onclick=`showReaderInfo(${JSON.stringify(book).replace(/'/g, "\\'")})` title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∏—Ç–∞—Ç–µ–ª–µ")
                        i.fas.fa-user
                      button.btn.btn-warning(onclick=`returnBook('${book.id}')` title="–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É")
                        i.fas.fa-undo
                    button.btn.btn-danger(onclick=`confirmDelete('${book.id}', '${safeTitle}')` title="–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É")
                      i.fas.fa-trash

              .book-details
                p
                  i.fas.fa-user-edit
                  |  –ê–≤—Ç–æ—Ä: #{book.author}
                p
                  i.fas.fa-calendar
                  |  –ì–æ–¥: #{book.year}
                p
                  i.fas.fa-tag
                  |  –ñ–∞–Ω—Ä: #{book.genre}
                
                if !book.isAvailable && book.dueDate
                  p
                    i.fas.fa-clock
                    |  –í–µ—Ä–Ω—É—Ç—å –¥–æ: #{book.dueDate}
                    span.urgent(data-due-date=book.dueDate) (–°—Ä–æ—á–Ω–æ!)

//- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ
dialog#bookInfoDialog.modal
  .modal-content
    .modal-header
      h3.modal-title
        i.fas.fa-info-circle
        |  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ
      button.close(type="button" onclick="closeBookInfoDialog()") &times;
    
    .book-info-content#bookInfoContent
      //- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript

    .modal-actions
      button.btn.btn-primary(type="button" onclick="closeBookInfoDialog()")
        i.fas.fa-check
        |  –ó–∞–∫—Ä—ã—Ç—å

//- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏
dialog#editBookDialog.modal
  .modal-content
    .modal-header
      h3.modal-title
        i.fas.fa-edit
        |  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É
      button.close(type="button" onclick="closeEditBookDialog()") &times;
    
    form#editBookForm
      input(type="hidden", id="editBookId")
      
      .form-group
        label(for="editTitle")
          i.fas.fa-book
          |  –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏:
        input(type="text", id="editTitle", name="title", required, placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏")
      
      .form-group
        label(for="editAuthor")
          i.fas.fa-user-edit
          |  –ê–≤—Ç–æ—Ä:
        input(type="text", id="editAuthor", name="author", required, placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–≤—Ç–æ—Ä–∞")
      
      .form-group
        label(for="editYear")
          i.fas.fa-calendar
          |  –ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è:
        input(type="number", id="editYear", name="year", required, placeholder="2024", min="1000", max="2030")
      
      .form-group
        label(for="editGenre")
          i.fas.fa-tag
          |  –ñ–∞–Ω—Ä:
        input(type="text", id="editGenre", name="genre", required, placeholder="–í–≤–µ–¥–∏—Ç–µ –∂–∞–Ω—Ä")
      
      .modal-actions
        button.btn.btn-secondary(type="button" onclick="closeEditBookDialog()")
          i.fas.fa-times
          |  –û—Ç–º–µ–Ω–∞
        button.btn.btn-success(type="submit")
          i.fas.fa-check
          |  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

//- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏
dialog#borrowDialog.modal
  .modal-content
    .modal-header
      h3.modal-title
        i.fas.fa-hand-holding
        |  –í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É —á–∏—Ç–∞—Ç–µ–ª—é
      button.close(type="button" onclick="closeBorrowDialog()") &times;
    
    form#borrowForm
      input(type="hidden", id="borrowBookId")
      
      .form-group
        label(for="readerName")
          i.fas.fa-user
          |  –§–ò–û —á–∏—Ç–∞—Ç–µ–ª—è:
        input(type="text", id="readerName", name="readerName", required, placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è —á–∏—Ç–∞—Ç–µ–ª—è")
      
      .form-group
        label(for="readerEmail")
          i.fas.fa-envelope
          |  Email —á–∏—Ç–∞—Ç–µ–ª—è:
        input(type="email", id="readerEmail", name="readerEmail", placeholder="email@example.com")
      
      .form-group
        label(for="readerPhone")
          i.fas.fa-phone
          |  –¢–µ–ª–µ—Ñ–æ–Ω —á–∏—Ç–∞—Ç–µ–ª—è:
        input(type="tel", id="readerPhone", name="readerPhone", placeholder="+7 (999) 999-99-99")
      
      .form-group
        label(for="dueDate")
          i.fas.fa-calendar
          |  –î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞:
        input(type="date", id="dueDate", name="dueDate", required)
      
      .modal-actions
        button.btn.btn-secondary(type="button" onclick="closeBorrowDialog()")
          i.fas.fa-times
          |  –û—Ç–º–µ–Ω–∞
        button.btn.btn-success(type="submit")
          i.fas.fa-check
          |  –í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É

//- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∏—Ç–∞—Ç–µ–ª–µ
dialog#readerInfoDialog.modal
  .modal-content
    .modal-header
      h3.modal-title
        i.fas.fa-user-circle
        |  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∏—Ç–∞—Ç–µ–ª–µ
      button.close(type="button" onclick="closeReaderInfoDialog()") &times;
    
    .reader-info
      .info-item
        strong
          i.fas.fa-book
          |  –ö–Ω–∏–≥–∞:
        span#infoBookTitle
      .info-item
        strong
          i.fas.fa-user
          |  –ß–∏—Ç–∞—Ç–µ–ª—å:
        span#infoReaderName
      .info-item
        strong
          i.fas.fa-envelope
          |  Email:
        span#infoReaderEmail
      .info-item
        strong
          i.fas.fa-phone
          |  –¢–µ–ª–µ—Ñ–æ–Ω:
        span#infoReaderPhone
      .info-item
        strong
          i.fas.fa-calendar-check
          |  –î–∞—Ç–∞ –≤—ã–¥–∞—á–∏:
        span#infoBorrowDate
      .info-item
        strong
          i.fas.fa-calendar-times
          |  –í–µ—Ä–Ω—É—Ç—å –¥–æ:
        span#infoDueDate
    
    .modal-actions
      button.btn.btn-primary(type="button" onclick="closeReaderInfoDialog()")
        i.fas.fa-check
        |  –ó–∞–∫—Ä—ã—Ç—å

script.
  //- –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–π –∫–Ω–∏–≥–∏
  let currentBookData = null;
  
  //- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–Ω–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('filterSelect').addEventListener('change', applyFilters);
    document.getElementById('sortSelect').addEventListener('change', applyFilters);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('editBookForm').addEventListener('submit', handleEditBook);
    
    // –î–û–ë–ê–í–õ–Ø–ï–ú –û–ë–†–ê–ë–û–¢–ß–ò–ö –§–û–†–ú–´ –í–´–î–ê–ß–ò –ö–ù–ò–ì–ò
    const borrowForm = document.getElementById('borrowForm');
    if (borrowForm) {
      borrowForm.addEventListener('submit', handleBorrowBook);
      console.log('–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω');
    } else {
      console.error('–§–æ—Ä–º–∞ –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–æ—á–Ω—ã–µ –º–µ—Ç–∫–∏
    updateUrgentLabels();
  });
  
  //- –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏
  function handleBorrowBook(e) {
    e.preventDefault();
    console.log('–§–æ—Ä–º–∞ –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
    
    const bookId = document.getElementById('borrowBookId').value;
    const readerName = document.getElementById('readerName').value.trim();
    const readerEmail = document.getElementById('readerEmail').value.trim();
    const readerPhone = document.getElementById('readerPhone').value.trim();
    const dueDate = document.getElementById('dueDate').value;
    
    console.log('–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–¥–∞—á–∏:', { bookId, readerName, readerEmail, readerPhone, dueDate });
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!readerName) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –§–ò–û —á–∏—Ç–∞—Ç–µ–ª—è');
      document.getElementById('readerName').focus();
      return;
    }
    
    if (!dueDate) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤–æ–∑–≤—Ä–∞—Ç–∞');
      document.getElementById('dueDate').focus();
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–µ –≤ –ø—Ä–æ—à–ª–æ–º
    const today = new Date().toISOString().split('T')[0];
    if (dueDate < today) {
      alert('–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –ø—Ä–æ—à–ª–æ–º');
      document.getElementById('dueDate').focus();
      return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/books/${bookId}/borrow`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        borrower: readerName,
        readerEmail: readerEmail,
        readerPhone: readerPhone,
        dueDate: dueDate
      })
    })
    .then(response => {
      console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
      if (data.success) {
        alert('‚úÖ –ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–¥–∞–Ω–∞ —á–∏—Ç–∞—Ç–µ–ª—é: ' + readerName);
        closeBorrowDialog();
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        setTimeout(() => {
          location.reload();
        }, 500);
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
      }
    })
    .catch(error => {
      console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏:', error);
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ AJAX
  function applyFilters() {
    const filter = document.getElementById('filterSelect').value;
    const sort = document.getElementById('sortSelect').value;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    showLoading();
    
    // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    fetch(`/books/api/filter?filter=${filter}&sort=${sort}`)
      .then(response => response.json())
      .then(data => {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        updateStatistics(data.statistics);
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
        updateBooksContainer(data.books);
        // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
        updateBooksTitle(data.message);
      })
      .catch(error => {
        console.error('–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–Ω–∏–≥');
        // –ü—Ä–∏ –æ—à–∏–±–∫–µ - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å—Ç–∞—Ä—ã–º —Å–ø–æ—Å–æ–±–æ–º
        window.location.href = `/books?filter=${filter}&sort=${sort}`;
      })
      .finally(() => {
        hideLoading();
      });
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
  function updateStatistics(statistics) {
    document.getElementById('totalBooks').textContent = statistics.totalBooks;
    document.getElementById('availableBooks').textContent = statistics.availableBooks;
    document.getElementById('borrowedBooks').textContent = statistics.borrowedBooks;
    document.getElementById('expiringBooks').textContent = statistics.expiringBooks;
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞
  function updateBooksTitle(message) {
    document.getElementById('booksTitle').innerHTML = `<i class="fas fa-books"></i> ${message}`;
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∫–Ω–∏–≥–∞–º–∏
  function updateBooksContainer(books) {
    const container = document.getElementById('booksContainer');
    
    if (books.length === 0) {
      container.innerHTML = `
        <div class="no-books">
          <i class="fas fa-book-open"></i>
          <p>–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        </div>
      `;
      return;
    }
    
    const booksHTML = books.map(book => {
      const safeTitle = book.title.replace(/'/g, "\\'");
      const safeAuthor = book.author.replace(/'/g, "\\'");
      const safeGenre = book.genre.replace(/'/g, "\\'");
      
      return `
        <div class="book-card" id="book-${book.id}">
          <div class="book-header">
            <h4>
              <i class="fas fa-book"></i> ${book.title}
            </h4>
            <div class="book-actions">
              ${book.isAvailable ? 
                `<span class="status available">
                  <i class="fas fa-check-circle"></i> –î–æ—Å—Ç—É–ø–Ω–∞
                </span>` : 
                `<span class="status borrowed">
                  <i class="fas fa-user-clock"></i> –í—ã–¥–∞–Ω–∞: ${book.borrower || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                </span>`
              }
              
              <div class="action-buttons">
                <button class="btn btn-info" onclick="showBookDetails(${JSON.stringify(book).replace(/'/g, "\\'")})" title="–ü–æ–¥—Ä–æ–±–Ω–µ–µ">
                  <i class="fas fa-info"></i>
                </button>
                <button class="btn btn-warning" onclick="showEditDialog('${book.id}', '${safeTitle}', '${safeAuthor}', '${book.year}', '${safeGenre}')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É">
                  <i class="fas fa-edit"></i>
                </button>
                ${book.isAvailable ? 
                  `<button class="btn btn-success" onclick="showBorrowDialog('${book.id}', '${safeTitle}')" title="–í—ã–¥–∞—Ç—å –∫–Ω–∏–≥—É">
                    <i class="fas fa-hand-holding"></i>
                  </button>` : 
                  `<button class="btn btn-info" onclick="showReaderInfo(${JSON.stringify(book).replace(/'/g, "\\'")})" title="–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —á–∏—Ç–∞—Ç–µ–ª–µ">
                    <i class="fas fa-user"></i>
                  </button>
                  <button class="btn btn-warning" onclick="returnBook('${book.id}')" title="–í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É">
                    <i class="fas fa-undo"></i>
                  </button>`
                }
                <button class="btn btn-danger" onclick="confirmDelete('${book.id}', '${safeTitle}')" title="–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          </div>

          <div class="book-details">
            <p>
              <i class="fas fa-user-edit"></i> –ê–≤—Ç–æ—Ä: ${book.author}
            </p>
            <p>
              <i class="fas fa-calendar"></i> –ì–æ–¥: ${book.year}
            </p>
            <p>
              <i class="fas fa-tag"></i> –ñ–∞–Ω—Ä: ${book.genre}
            </p>
            ${!book.isAvailable && book.dueDate ? `
            <p>
              <i class="fas fa-clock"></i> –í–µ—Ä–Ω—É—Ç—å –¥–æ: ${book.dueDate}
              <span class="urgent" data-due-date="${book.dueDate}">(–°—Ä–æ—á–Ω–æ!)</span>
            </p>
            ` : ''}
          </div>
        </div>
      `;
    }).join('');
    
    container.innerHTML = booksHTML;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–æ—á–Ω—ã–µ –º–µ—Ç–∫–∏ –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
    updateUrgentLabels();
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
  function showLoading() {
    const container = document.getElementById('booksContainer');
    container.innerHTML = `
      <div class="loading">
        <i class="fas fa-spinner fa-spin"></i>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–Ω–∏–≥...</p>
      </div>
    `;
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
  function hideLoading() {
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ä–æ—á–Ω—ã—Ö –º–µ—Ç–æ–∫
  function updateUrgentLabels() {
    const urgentSpans = document.querySelectorAll('.urgent');
    urgentSpans.forEach(span => {
      const dueDate = span.getAttribute('data-due-date');
      if (!isExpiring(dueDate)) {
        span.style.display = 'none';
      }
    });
  }

  //- –§–£–ù–ö–¶–ò–ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ö–ù–ò–ì
  
  //- –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏
  function showEditDialog(bookId, title, author, year, genre) {
    const dialog = document.getElementById('editBookDialog');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–Ω–∏–≥–∏
    document.getElementById('editBookId').value = bookId;
    document.getElementById('editTitle').value = title;
    document.getElementById('editAuthor').value = author;
    document.getElementById('editYear').value = year;
    document.getElementById('editGenre').value = genre;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    dialog.showModal();
  }
  
  //- –ó–∞–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏
  function closeEditBookDialog() {
    const dialog = document.getElementById('editBookDialog');
    dialog.close();
  }
  
  //- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏
  function handleEditBook(e) {
    e.preventDefault();
    
    const bookId = document.getElementById('editBookId').value;
    const title = document.getElementById('editTitle').value.trim();
    const author = document.getElementById('editAuthor').value.trim();
    const year = document.getElementById('editYear').value.trim();
    const genre = document.getElementById('editGenre').value.trim();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!title || !author || !year || !genre) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }
    
    if (year < 1000 || year > 2030) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≥–æ–¥ (1000-2030)');
      document.getElementById('editYear').focus();
      return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    fetch(`/books/${bookId}/update`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        title: title,
        author: author,
        year: year,
        genre: genre
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('‚úÖ –ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        closeEditBookDialog();
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ —á–µ—Ä–µ–∑ AJAX
        applyFilters();
      } else {
        alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
      }
    })
    .catch(error => {
      alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
    });
  }

  //- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
  
  //- –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ
  function showBookDetails(book) {
    const dialog = document.getElementById('bookInfoDialog');
    const content = document.getElementById('bookInfoContent');
    
    const bookInfoHTML = `
      <div class="book-info">
        <div class="info-section">
          <h4>${book.title}</h4>
          <div class="info-grid">
            <div class="info-item">
              <strong><i class="fas fa-user-edit"></i> –ê–≤—Ç–æ—Ä:</strong>
              <span>${book.author}</span>
            </div>
            <div class="info-item">
              <strong><i class="fas fa-calendar"></i> –ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è:</strong>
              <span>${book.year}</span>
            </div>
            <div class="info-item">
              <strong><i class="fas fa-tag"></i> –ñ–∞–Ω—Ä:</strong>
              <span>${book.genre}</span>
            </div>
            <div class="info-item">
              <strong><i class="fas fa-calendar-plus"></i> –î–æ–±–∞–≤–ª–µ–Ω–∞:</strong>
              <span>${book.addedDate || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
            </div>
            <div class="info-item">
              <strong><i class="fas fa-check-circle"></i> –°—Ç–∞—Ç—É—Å:</strong>
              <span>${book.isAvailable ? '–î–æ—Å—Ç—É–ø–Ω–∞' : '–í—ã–¥–∞–Ω–∞: ' + (book.borrower || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')}</span>
            </div>
            ${!book.isAvailable && book.dueDate ? `
            <div class="info-item">
              <strong><i class="fas fa-clock"></i> –í–µ—Ä–Ω—É—Ç—å –¥–æ:</strong>
              <span>${new Date(book.dueDate).toLocaleDateString('ru-RU')}</span>
              ${isExpiring(book.dueDate) ? '<span class="urgent">(–°—Ä–æ—á–Ω–æ!)</span>' : ''}
            </div>
            ` : ''}
            ${!book.isAvailable && book.readerEmail ? `
            <div class="info-item">
              <strong><i class="fas fa-envelope"></i> Email —á–∏—Ç–∞—Ç–µ–ª—è:</strong>
              <span>${book.readerEmail}</span>
            </div>
            ` : ''}
            ${!book.isAvailable && book.readerPhone ? `
            <div class="info-item">
              <strong><i class="fas fa-phone"></i> –¢–µ–ª–µ—Ñ–æ–Ω —á–∏—Ç–∞—Ç–µ–ª—è:</strong>
              <span>${book.readerPhone}</span>
            </div>
            ` : ''}
          </div>
        </div>
      </div>
    `;
    
    content.innerHTML = bookInfoHTML;
    dialog.showModal();
  }
  
  //- –ó–∞–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ
  function closeBookInfoDialog() {
    const dialog = document.getElementById('bookInfoDialog');
    dialog.close();
  }
  
  //- –ü–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ª–æ–≥ –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏
  function showBorrowDialog(bookId, bookTitle) {
    const dialog = document.getElementById('borrowDialog');
    document.getElementById('borrowBookId').value = bookId;
    
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('readerName').value = '';
    document.getElementById('readerEmail').value = '';
    document.getElementById('readerPhone').value = '';
    document.getElementById('dueDate').value = '';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É - —Å–µ–≥–æ–¥–Ω—è
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dueDate').min = today;
    
    // –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—É –≤–æ–∑–≤—Ä–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ 14 –¥–Ω–µ–π)
    const twoWeeksLater = new Date();
    twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
    document.getElementById('dueDate').value = twoWeeksLater.toISOString().split('T')[0];
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    dialog.showModal();
  }
  
  //- –ó–∞–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –≤—ã–¥–∞—á–∏ –∫–Ω–∏–≥–∏
  function closeBorrowDialog() {
    const dialog = document.getElementById('borrowDialog');
    dialog.close();
  }
  
  //- –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —á–∏—Ç–∞—Ç–µ–ª–µ
  function showReaderInfo(book) {
    currentBookData = book;
    const dialog = document.getElementById('readerInfoDialog');
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    document.getElementById('infoBookTitle').textContent = book.title;
    document.getElementById('infoReaderName').textContent = book.borrower || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    document.getElementById('infoReaderEmail').textContent = book.readerEmail || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    document.getElementById('infoReaderPhone').textContent = book.readerPhone || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    document.getElementById('infoBorrowDate').textContent = book.borrowedDate ? new Date(book.borrowedDate).toLocaleDateString('ru-RU') : new Date().toLocaleDateString('ru-RU');
    document.getElementById('infoDueDate').textContent = book.dueDate ? new Date(book.dueDate).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥
    dialog.showModal();
  }
  
  //- –ó–∞–∫—Ä—ã—Ç—å –¥–∏–∞–ª–æ–≥ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∏—Ç–∞—Ç–µ–ª–µ
  function closeReaderInfoDialog() {
    const dialog = document.getElementById('readerInfoDialog');
    dialog.close();
  }
  
  //- –ó–∞–∫—Ä—ã—Ç–∏–µ –¥–∏–∞–ª–æ–≥–æ–≤ –ø–æ –∫–ª–∏–∫—É –Ω–∞ —Ñ–æ–Ω
  document.querySelectorAll('dialog').forEach(dialog => {
    dialog.addEventListener('click', (e) => {
      const dialogDimensions = dialog.getBoundingClientRect();
      if (
        e.clientX < dialogDimensions.left ||
        e.clientX > dialogDimensions.right ||
        e.clientY < dialogDimensions.top ||
        e.clientY > dialogDimensions.bottom
      ) {
        dialog.close();
      }
    });
  });
  
  //- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function confirmDelete(bookId, bookTitle) {
    if (confirm(`üóëÔ∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "${bookTitle}"?`)) {
      fetch(`/books/${bookId}/delete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('‚úÖ ' + data.message);
          // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —á–µ—Ä–µ–∑ AJAX –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
          applyFilters();
        } else {
          alert('‚ùå –û—à–∏–±–∫–∞: ' + data.message);
        }
      });
    }
  }
  
  function returnBook(bookId) {
    if (confirm('üìö –í–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É?')) {
      fetch(`/books/${bookId}/return`, {
        method: 'POST'
      })
      .then(response => response.json())
      .then(data => {
        alert('‚úÖ ' + data.message);
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã —á–µ—Ä–µ–∑ AJAX –≤–º–µ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
        applyFilters();
      });
    }
  }
  
  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ (–Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ)
  function isExpiring(dueDate) {
    if (!dueDate) return false;
    const now = new Date();
    const due = new Date(dueDate);
    const diffTime = due - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays <= 7 && diffDays > 0;
  }

  //- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ä–æ—á–Ω—ã—Ö –º–µ—Ç–æ–∫ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', function() {
    const urgentSpans = document.querySelectorAll('.urgent');
    urgentSpans.forEach(span => {
      const dueDate = span.getAttribute('data-due-date');
      if (!isExpiring(dueDate)) {
        span.style.display = 'none';
      }
    });
  });